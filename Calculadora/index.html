<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora para Portfólio</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .calculator-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .calculator-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .calculator-display {
            padding: 20px;
            background-color: var(--dark-color);
            color: white;
            text-align: right;
            font-size: 2em;
            min-height: 80px;
            word-wrap: break-word;
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #ddd;
        }
        
        button {
            border: none;
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s;
        }
        
        button:hover {
            background-color: #eee;
        }
        
        .btn-operation {
            background-color: var(--light-color);
        }
        
        .btn-equals {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-clear {
            background-color: var(--danger-color);
            color: white;
        }
        
        .history-container {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding: 20px;
        }
        
        .history-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
        
        @media (max-width: 600px) {
            .calculator-container {
                width: 100%;
                border-radius: 0;
            }
            
            button {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="calculator-header">
            <h1>Calculadora</h1>
            <p>Conectada ao back-end Flask</p>
        </div>
        
        <div class="calculator-display" id="display">0</div>
        
        <div class="calculator-buttons">
            <button class="btn-clear" onclick="clearDisplay()">C</button>
            <button onclick="appendToDisplay('%')">%</button>
            <button onclick="appendToDisplay('√')">√</button>
            <button onclick="appendToDisplay('^')">^</button>
            
            <button onclick="appendToDisplay('7')">7</button>
            <button onclick="appendToDisplay('8')">8</button>
            <button onclick="appendToDisplay('9')">9</button>
            <button class="btn-operation" onclick="appendToDisplay('/')">÷</button>
            
            <button onclick="appendToDisplay('4')">4</button>
            <button onclick="appendToDisplay('5')">5</button>
            <button onclick="appendToDisplay('6')">6</button>
            <button class="btn-operation" onclick="appendToDisplay('*')">×</button>
            
            <button onclick="appendToDisplay('1')">1</button>
            <button onclick="appendToDisplay('2')">2</button>
            <button onclick="appendToDisplay('3')">3</button>
            <button class="btn-operation" onclick="appendToDisplay('-')">-</button>
            
            <button onclick="appendToDisplay('0')">0</button>
            <button onclick="appendToDisplay('.')">.</button>
            <button class="btn-equals" onclick="calculate()">=</button>
            <button class="btn-operation" onclick="appendToDisplay('+')">+</button>
        </div>
        
        <div class="history-container">
            <div class="history-title">
                <h2>Histórico</h2>
                <button onclick="clearHistory()">Limpar</button>
            </div>
            <div class="history-list" id="historyList">
                <!-- Histórico será carregado aqui -->
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentInput = '0';
        let operationInProgress = false;
        const display = document.getElementById('display');
        const historyList = document.getElementById('historyList');
        
        // Carrega o histórico quando a página é aberta
        document.addEventListener('DOMContentLoaded', () => {
            updateDisplay();
            loadHistory();
        });
        
        // Atualiza o visor da calculadora
        function updateDisplay() {
            display.textContent = currentInput;
        }
        
        // Limpa o visor
        function clearDisplay() {
            currentInput = '0';
            operationInProgress = false;
            updateDisplay();
        }
        
        // Adiciona caracteres ao visor
        function appendToDisplay(value) {
            if (currentInput === '0' || operationInProgress) {
                currentInput = value;
                operationInProgress = false;
            } else {
                currentInput += value;
            }
            updateDisplay();
        }
        
        // Calcula o resultado
        async function calculate() {
            try {
                // Extrai os números e a operação do visor
                let operation, a, b;
                
                if (currentInput.includes('+')) {
                    operation = 'somar';
                    [a, b] = currentInput.split('+').map(Number);
                } else if (currentInput.includes('-')) {
                    operation = 'subtrair';
                    [a, b] = currentInput.split('-').map(Number);
                } else if (currentInput.includes('*')) {
                    operation = 'multiplicar';
                    [a, b] = currentInput.split('*').map(Number);
                } else if (currentInput.includes('/')) {
                    operation = 'dividir';
                    [a, b] = currentInput.split('/').map(Number);
                } else if (currentInput.includes('^')) {
                    operation = 'potencia';
                    [a, b] = currentInput.split('^').map(Number);
                } else if (currentInput.includes('√')) {
                    operation = 'raiz_quadrada';
                    a = Number(currentInput.replace('√', ''));
                } else if (currentInput.includes('%')) {
                    operation = 'porcentagem';
                    [a, b] = currentInput.split('%').map(Number);
                } else {
                    return; // Nenhuma operação encontrada
                }
                
                // Prepara os dados para enviar ao back-end
                const payload = { operacao: operation, a: a };
                if (b !== undefined) payload.b = b;
                
                // Faz a requisição para o back-end
                const response = await fetch('http://localhost:5000/api/calcular', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.erro) {
                    alert(`Erro: ${data.erro}`);
                } else {
                    currentInput = data.resultado.toString();
                    operationInProgress = true;
                    updateDisplay();
                    loadHistory(); // Atualiza o histórico após cálculo
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Ocorreu um erro ao calcular. Verifique o console para mais detalhes.');
            }
        }
        
        // Carrega o histórico do back-end
        async function loadHistory() {
            try {
                const response = await fetch('http://localhost:5000/api/historico');
                const history = await response.json();
                
                historyList.innerHTML = '';
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="history-item">Nenhuma operação no histórico</div>';
                    return;
                }
                
                // Ordena do mais recente para o mais antigo
                history.reverse().forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div>
                            <strong>${item.operacao}</strong>
                            <div class="timestamp">${item.data_hora}</div>
                        </div>
                        <div>${item.resultado}</div>
                    `;
                    historyList.appendChild(historyItem);
                });
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                historyList.innerHTML = '<div class="history-item">Erro ao carregar histórico</div>';
            }
        }
        
        // Limpa o histórico no back-end
        async function clearHistory() {
            try {
                await fetch('http://localhost:5000/api/limpar_historico', {
                    method: 'POST'
                });
                loadHistory(); // Recarrega o histórico vazio
            } catch (error) {
                console.error('Erro ao limpar histórico:', error);
                alert('Erro ao limpar histórico');
            }
        }
    </script>
</body>
</html>